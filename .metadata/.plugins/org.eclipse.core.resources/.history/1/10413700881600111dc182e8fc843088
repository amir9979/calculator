package dev.log.handler;

import java.util.HashMap;

import org.ebayopensource.turmeric.runtime.common.exceptions.ServiceException;
import org.ebayopensource.turmeric.runtime.common.impl.handlers.BaseHandler;
import org.ebayopensource.turmeric.runtime.common.pipeline.InboundMessage;
import org.ebayopensource.turmeric.runtime.common.pipeline.Message;
import org.ebayopensource.turmeric.runtime.common.pipeline.MessageContext;

import dev.log.trace.TraceStatePoint;

public class RequestLogHeaderHandler extends BaseHandler {

	public static final String PROCESS_ID = "LOG-PROCESS-ID";
	public static final String SEQUENCE_ID = "LOG-SEQUENCE-ID";
	
	private String service_id;
	
	private int requestCount = 0;
	
	HashMap<String,Integer> sequenceCounters = new HashMap<String,Integer>();
	
	public void init(InitContext ctx) throws ServiceException {
		service_id = ctx.getServiceId().getNamespace() + "_" + ctx.getServiceId().getAdminName();
	}
	
	@Override
	public void invoke(MessageContext ctx) throws ServiceException {

		System.out.println(ctx.getServiceId().getAdminName() + " RequestLogHeaderHandler for "+ctx.getRequestMessage());
		
		/**
		 * Handle an incoming request
		 */
		if(ctx.getRequestMessage() instanceof InboundMessage) {
			
			Message requestMsg = ctx.getRequestMessage();
			
			String processId = requestMsg.getTransportHeader(PROCESS_ID);
			String sequenceId = requestMsg.getTransportHeader(SEQUENCE_ID);
			System.out.println("Handling incoming message:");
			System.out.println(processId);
			System.out.println(sequenceId);
			/**
			 * The service might already be involved in the request, copy the counter of the request
			 */
			if(processId != null && sequenceCounters.containsKey(processId)) {
				sequenceCounters.put(processId, Integer.parseInt(sequenceId));
			} else {
				/**
				 * Initialize the request chain at this service
				 */
				processId = service_id + "_" + increaseRequestCount();
				sequenceId = "0";
				
				sequenceCounters.put(processId, Integer.parseInt(sequenceId));
				requestMsg.setTransportHeader(PROCESS_ID, processId);
				requestMsg.setTransportHeader(SEQUENCE_ID, sequenceId);
			}
			System.out.println("test: "+ ctx.getOperationName() + ctx.getOperation().getMethodName());
			//logIncomingMessage(requestMsg);
		}
		
		/**
		 * Handle an outgoing request
		 */
		else {
			/**
			 * Get the values for the headers
			 */
			System.out.println("Handling outgoing message:");
			String requestId = ctx.getRequestMessage().getTransportHeader(PROCESS_ID);
			String sequenceId = ctx.getRequestMessage().getTransportHeader(SEQUENCE_ID);
			
			ctx.getRequestMessage().setTransportHeader(SEQUENCE_ID, "" + (Integer.parseInt(sequenceId) + 1));
			
//			MessageContext context = MessageContextAccessorImpl.getContext();
//			String requestId = "";
//			int sequenceId = 0;
//			ctx.getRequestMessage().setTransportHeader(REQUEST_ID, requestId);
//			ctx.getRequestMessage().setTransportHeader(SEQUENCE_ID, ""+sequenceId);
		}
		System.out.println("END OF REQUESTLOGHEADERHANDLER");
	}
	
	private void logIncomingMessage(Message requestMsg) throws ServiceException {
		String process_id = requestMsg.getTransportHeader(PROCESS_ID);
		String interface_id = requestMsg.getParamDesc().getXmlToJavaMappings().toString();
		String sequence_id = requestMsg.getTransportHeader(SEQUENCE_ID);
		TraceStatePoint point = new TraceStatePoint(process_id, interface_id, service_id, sequence_id);
		
	}

	private int increaseRequestCount(){
		requestCount++;
		return requestCount;
	}

}
